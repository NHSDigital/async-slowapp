parameters:
  - name: test_type

  - name: python_version
    type: string
    default: ''

steps:
    - task: UsePythonVersion@0
      displayName: "Use Python ${{ parameters.python_version }}"
      inputs:
        versionSpec: ${{ parameters.python_version }}

    - task: s3-cache-action@1
      inputs:
        key: 'poetry | ./poetry.lock'
        location: '.venv'
        debug: true
        workingDirectory: $(SERVICE_DIR)
      name: poetryCache
      displayName: cache python dependencies

    - bash: |
        make install-python
      workingDirectory: $(SERVICE_DIR)
      condition: ne(variables['poetryCache.cacheRestored'], 'true')
      displayName: poetry install

    - bash: |
        export SOURCE_COMMIT_ID=$(Build.SourceVersion)
        export PROXY_NAME="$(FULLY_QUALIFIED_SERVICE_NAME)"
        export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"
        make -C e2e ${{ parameters.test_type }}

      workingDirectory: $(SERVICE_DIR)
      displayName: run ${{ parameters.test_type }} tests

    - task: PublishTestResults@2
      displayName: publish ${{ parameters.test_type }} test results
      inputs:
          testResultsFiles: |
              $(SERVICE_DIR)/reports/${{ parameters.test_type }}.xml
          failTaskOnFailedTests: true
